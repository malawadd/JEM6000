<script setup>
/** Vendor */
import { ref, watch, onMounted, onUnmounted } from "vue"
import { DateTime } from "luxon"

/** Config */
import { useServerURL, useSocketURL } from "@/services/config"

/** Local Components */
import Globe from "../local/Globe.vue"
import Feed from "../local/Feed.vue"
import TPM from "../local/TPM.vue"

/** UI */
import { Dropdown, DropdownItem } from "@/components/ui/Dropdown"
import Tooltip from "@/components/ui/Tooltip.vue"

/** Store */
import { useAppStore } from "@/stores/app"
const appStore = useAppStore()

const globeWidgetEl = ref(null)

const txs = ref([])

const socket = ref(null)

const startWs = () => {
  socket.value = new WebSocket(useSocketURL())

  socket.value.addEventListener("open", (e) => {
    console.log("WebSocket connection established")
  })

  socket.value.addEventListener("message", (e) => {
    const data = JSON.parse(e.data)
    console.log("Received transaction:", data)
    
    // Add the new transaction to the beginning of the array
    txs.value.unshift(data)
    
    // Keep only the last 100 transactions
    if (txs.value.length > 100) {
      txs.value.pop()
    }
  })

  socket.value.addEventListener("close", () => {
    console.log("WebSocket connection closed. Attempting to reconnect...")
    socket.value = null
    setTimeout(startWs, 1000)
  })

  socket.value.addEventListener("error", (error) => {
    console.error("WebSocket error:", error)
  })
}

onMounted(() => {
  startWs()
})

onUnmounted(() => {
  if (socket.value) {
    socket.value.close()
  }
})

watch(
  () => appStore.network,
  () => {
    if (socket.value) {
      socket.value.close()
    }
    txs.value = []
    startWs()
  },
)
</script>

<template>
	<Flex ref="globeWidgetEl" justify="between" :class="$style.wrapper">
		<Globe v-if="globeWidgetEl" :parent="globeWidgetEl?.wrapper" :txs="txs" />
		<div :class="$style.atm_wrapper">
			<div :class="$style.atm" />
		</div>

		<Flex direction="column" gap="24" :class="$style.controls">
			<Flex direction="column" gap="20">
				<Flex direction="column" gap="12">


					<Flex align="center" gap="12">
						<Flex align="center" gap="8">
							<Text size="14" weight="500" color="tertiary"> JEM6000 API: </Text>

							<Flex align="center" gap="4">
								<Icon name="zap-circle" size="14" color="green" />
								<Text size="14" weight="600" color="green"> Stable </Text>
							</Flex>
						</Flex>

						<div :class="$style.dot" />

						<Flex align="center" gap="8">
							<Text size="14" weight="500" color="tertiary"> Socket: </Text>
							<Flex align="center" gap="4">
								<Icon name="check-circle" size="14" color="secondary" />
								<Text size="14" weight="600" color="secondary"> Connected </Text>
							</Flex>
						</Flex>
					</Flex>
				</Flex>

				<Dropdown fullWidth>
					<Flex align="center" gap="16" :class="$style.network_selector">
						<Flex align="center" gap="8">
							<svg width="14" height="14" viewBox="0 0 14 14" fill="none"
								xmlns="http://www.w3.org/2000/svg">
								<path fill-rule="evenodd" clip-rule="evenodd"
									d="M13.4177 7.19085C13.4163 7.23422 13.3573 7.24568 13.3402 7.2057C13.3329 7.18845 13.3254 7.17114 13.3178 7.15383C13.3039 7.12216 13.3078 7.08533 13.3286 7.05763C13.3329 7.05197 13.3416 7.04051 13.3521 7.02685C13.3801 6.99015 13.4206 6.99562 13.4206 7.03636C13.4206 7.0898 13.4194 7.13608 13.4177 7.19085ZM13.1069 6.34222C13.0591 6.4284 12.9364 6.43237 12.8833 6.34927C12.875 6.33643 12.8667 6.32359 12.8583 6.31068C12.6668 6.01662 12.4464 5.72797 12.2003 5.44745C12.1398 5.37858 12.1892 5.27048 12.2809 5.27042H12.2831C12.8583 5.27042 13.1599 5.41251 13.2519 5.58601C13.3287 5.73112 13.3052 5.98489 13.1069 6.34222ZM12.9784 9.35031C12.9475 9.42881 12.9152 9.50681 12.8813 9.58406C12.876 9.5947 12.871 9.60546 12.8656 9.61604C12.6538 10.0235 12.2986 10.3444 11.8239 10.5677C11.7173 10.6178 11.6008 10.5203 11.6325 10.407C11.7902 9.8428 11.9095 9.23095 11.9868 8.58951C12.0012 8.46989 12.0602 8.3601 12.1513 8.28128C12.3466 8.11237 12.5289 7.94372 12.6966 7.77626L12.6984 7.77437C12.7809 7.69203 12.9217 7.72747 12.9553 7.83915C13.121 8.38994 13.1302 8.90296 12.9784 9.35031ZM11.6879 11.3873C11.6396 11.4389 11.5904 11.4899 11.5401 11.5401C11.4526 11.6275 11.363 11.712 11.2715 11.7937C11.2138 11.8451 11.1264 11.7808 11.1591 11.7107C11.1684 11.6906 11.1777 11.6705 11.1869 11.6502C11.2253 11.5654 11.2625 11.4784 11.2986 11.3897C11.3072 11.3688 11.3252 11.3532 11.3471 11.3476C11.4381 11.3245 11.5269 11.299 11.6133 11.2711C11.6834 11.2486 11.7383 11.3335 11.6879 11.3873ZM10.7403 10.878C10.5486 10.9057 10.3471 10.9237 10.1363 10.9311C9.62189 10.9491 9.07797 10.9047 8.51925 10.8019C8.45113 10.7893 8.43804 10.6972 8.49979 10.666C8.62167 10.6043 8.74362 10.5412 8.8655 10.4766C9.72042 10.0235 10.5181 9.52816 11.2164 9.0203C11.2688 8.98221 11.3409 9.02716 11.3303 9.09106C11.2335 9.67308 11.0994 10.221 10.931 10.7183C10.9023 10.803 10.8289 10.8651 10.7403 10.878ZM10.5427 11.6534C10.0843 12.5549 9.51978 13.061 8.97258 13.0508C8.37785 13.0403 7.78482 12.4209 7.34565 11.3518L7.34515 11.3506C7.31726 11.2827 7.3493 11.205 7.41654 11.1758C7.4212 11.1737 7.42586 11.1717 7.43051 11.1696C7.45935 11.1571 7.49171 11.1548 7.52205 11.1634C8.34354 11.3939 9.15295 11.5142 9.9113 11.5142C9.9937 11.5142 10.0755 11.5129 10.1567 11.51C10.2517 11.5066 10.3452 11.5013 10.437 11.494C10.5222 11.4872 10.5814 11.5772 10.5427 11.6534ZM7.82832 13.3677C7.55579 13.4028 7.27923 13.4207 6.99997 13.4207C5.75196 13.4207 4.55828 13.067 3.53344 12.4071C3.46294 12.3616 3.4929 12.2522 3.57669 12.2484C3.59407 12.2475 3.61031 12.2467 3.6246 12.2458C3.88504 12.2288 4.17061 12.1907 4.48003 12.1311C5.13822 12.0045 5.86987 11.7873 6.63597 11.4948C6.70465 11.4686 6.78133 11.5027 6.80928 11.5707L6.80978 11.5718C7.10668 12.2947 7.47206 12.8409 7.88234 13.1883C7.95014 13.2458 7.91646 13.3564 7.82832 13.3677ZM4.11533 8.86902C4.6811 8.40832 5.34401 7.94863 6.0712 7.51342C6.08681 8.44351 6.1888 9.33646 6.36929 10.143C6.09959 10.028 5.83072 9.90135 5.56417 9.76291C5.04788 9.4946 4.56212 9.19406 4.11533 8.86902ZM2.35582 11.3611C2.22084 11.1065 2.39529 10.5166 3.2815 9.62007L3.28194 9.61963C3.37448 9.52614 3.36561 9.37272 3.2623 9.29132C3.22679 9.26343 3.19154 9.23523 3.15654 9.20702C3.06827 9.1357 2.94054 9.14225 2.8604 9.22251C2.84283 9.24008 2.82974 9.2533 2.8259 9.25726C2.38289 9.71198 2.07284 10.1329 1.89915 10.5115C1.84992 10.6188 1.70122 10.6304 1.63612 10.5319C0.948598 9.49259 0.579307 8.27473 0.579307 6.99997C0.579307 6.54424 0.626649 6.09575 0.718751 5.66011C0.732664 5.59419 0.825648 5.58998 0.845163 5.65444C0.978375 6.09424 1.19519 6.54915 1.49479 7.00916C1.89808 7.62851 2.42992 8.22387 3.06015 8.77C3.27527 8.9564 3.50247 9.1367 3.73943 9.31065C4.21977 9.66313 4.74173 9.98842 5.29705 10.2769C5.5432 10.4049 5.78293 10.5269 6.02845 10.6375C6.16513 10.699 6.32069 10.7038 6.4602 10.649C6.57597 10.6037 6.69256 10.5565 6.80985 10.5075C6.93739 10.4543 7.00658 10.3152 6.97277 10.1812C6.96855 10.1644 6.96522 10.151 6.96333 10.143C6.77 9.32941 6.66253 8.41348 6.64988 7.45412L6.6495 7.45431C6.64937 7.44292 6.64944 7.43133 6.64931 7.41981C6.64875 7.36737 6.64906 7.31455 6.64812 7.26224C6.6478 7.24555 6.6483 7.21729 6.64849 7.20054C6.64862 7.19387 6.64849 7.18726 6.64849 7.18065L6.64875 7.18058C6.64906 7.12053 6.6495 7.06053 6.65057 7.00028C6.65353 6.83572 6.65945 6.67235 6.66795 6.51031L6.66763 6.5105C6.72725 5.35283 6.92354 4.26504 7.23586 3.34999C7.26475 3.26532 7.21962 3.17341 7.13494 3.14451C7.05241 3.11631 6.96994 3.08936 6.88759 3.06355C6.80431 3.03743 6.71529 3.08238 6.68715 3.16503C6.34864 4.15877 6.13976 5.33772 6.08404 6.58529C6.07693 6.74355 5.99081 6.88759 5.85451 6.96837C5.11562 7.40628 4.43703 7.8705 3.8508 8.33844C3.72867 8.43596 3.55422 8.43225 3.43612 8.32982C2.84856 7.82039 2.35406 7.26708 1.98023 6.693C1.24562 5.56498 1.07104 4.50231 1.48881 3.70128C1.48994 3.69939 1.49095 3.69744 1.49202 3.69561C1.54528 3.60723 1.60068 3.52004 1.65835 3.43404C2.13837 2.79864 3.03182 2.43042 4.21675 2.38881C4.29173 2.38616 4.36721 2.38484 4.44339 2.38484C5.1702 2.38484 5.9502 2.50477 6.74349 2.73367L6.74368 2.73348C6.76106 2.73852 6.77843 2.74374 6.79581 2.74884C6.80922 2.75281 6.82263 2.75652 6.83603 2.76055C7.01936 2.81532 7.20319 2.87607 7.38726 2.9423C7.39154 2.94381 7.39589 2.94539 7.40017 2.9469C7.44814 2.96421 7.49605 2.98196 7.54396 3.00003C7.55894 3.0057 7.57399 3.01143 7.58897 3.01722C7.60339 3.02276 7.6178 3.02811 7.63228 3.03371L7.63209 3.03396C8.01952 3.18392 8.40662 3.3583 8.78888 3.55699C9.52879 3.94139 10.206 4.39202 10.7954 4.8864C9.67062 5.14407 8.36318 5.64116 7.04863 6.31137C6.98801 6.34235 6.94809 6.40329 6.94425 6.47128C6.93966 6.55274 6.93361 6.71655 6.92927 6.84674C6.92656 6.92845 7.013 6.98259 7.0854 6.94457L7.08615 6.94413C8.38767 6.26069 9.68661 5.74988 10.8021 5.47993C11.0106 5.42951 11.1456 5.22925 11.1163 5.01678C11.0958 4.86833 11.0727 4.72221 11.0471 4.57868C11.015 4.39838 10.9163 4.23715 10.7706 4.12622C10.2482 3.72823 9.67238 3.36315 9.056 3.04284C8.64062 2.82703 8.21914 2.63792 7.79678 2.47663C7.70644 2.44213 7.66773 2.33536 7.71488 2.25094C8.15002 1.4725 8.66757 1.03654 9.17177 1.03654C9.177 1.03654 9.18222 1.03654 9.18745 1.03667C9.78218 1.04731 10.3752 1.66659 10.8144 2.73575C11.0367 3.27697 11.2089 3.9011 11.3266 4.57937C11.326 4.5788 11.3254 4.5783 11.3248 4.57773C11.3751 4.8672 11.4155 5.16636 11.4456 5.47326C11.443 5.4749 11.4402 5.47634 11.4376 5.47798C11.4412 5.48157 11.4449 5.48516 11.4485 5.48881C11.4983 6.00378 11.5193 6.54002 11.5095 7.08722C11.5033 7.43335 11.4848 7.77469 11.455 8.10866C10.6593 8.75168 9.67553 9.39161 8.59416 9.96468C8.23879 10.153 7.88347 10.3284 7.53162 10.4898C7.52614 10.4923 7.52073 10.4948 7.51525 10.4973C7.48837 10.5096 7.46142 10.522 7.43454 10.5342L7.43391 10.534C7.14237 10.6659 6.8536 10.7879 6.56961 10.8993L6.56974 10.8996C6.55368 10.9059 6.53776 10.9119 6.52177 10.9181C6.50181 10.9259 6.48185 10.9336 6.46196 10.9413C6.4143 10.9596 6.36684 10.9776 6.31949 10.9952C6.30646 11.0001 6.29337 11.0052 6.28034 11.01C6.22286 11.0313 6.1657 11.052 6.10872 11.0724C6.10161 11.0749 6.09449 11.0777 6.08744 11.0802L6.08719 11.08C5.47861 11.2968 4.89886 11.4605 4.37055 11.5622C3.0939 11.808 2.49274 11.6194 2.35582 11.3611ZM3.27275 1.77059C4.3533 0.996821 5.6445 0.579307 6.99997 0.579307C7.35774 0.579307 7.71091 0.608581 8.05697 0.66568C8.14964 0.680978 8.18074 0.79927 8.10683 0.857251C7.77147 1.12015 7.45991 1.50914 7.18417 2.0136C7.11687 2.13667 6.97416 2.19686 6.83918 2.15883C5.92565 1.90167 5.02685 1.78067 4.19642 1.80981C3.89008 1.82058 3.59999 1.85162 3.32746 1.90185C3.2509 1.91596 3.20948 1.81586 3.27275 1.77059ZM12.0862 6.45C12.0844 6.3764 12.1788 6.34499 12.2215 6.40492C12.2739 6.47852 12.3245 6.55249 12.3729 6.62684C12.4372 6.72568 12.4971 6.82395 12.5527 6.92159C12.5874 6.98247 12.5791 7.05883 12.5319 7.11058C12.4569 7.19292 12.3756 7.27804 12.2873 7.3663C12.255 7.39847 12.2222 7.4307 12.1887 7.463C12.1471 7.50316 12.0774 7.47257 12.0797 7.41477C12.0838 7.30945 12.0868 7.20375 12.0887 7.09755C12.0926 6.87998 12.0917 6.66398 12.0862 6.45ZM11.4204 2.34323C11.4607 2.3815 11.5006 2.42041 11.5401 2.45988C12.1588 3.0786 12.6354 3.80157 12.9541 4.58894C12.9862 4.66832 12.9188 4.75142 12.8345 4.73625C12.6501 4.70314 12.4426 4.68834 12.2129 4.69218C12.0537 4.69483 11.9153 4.58327 11.8874 4.42652C11.7625 3.72653 11.582 3.07992 11.3502 2.5156C11.337 2.48343 11.3237 2.45164 11.3101 2.42016C11.2807 2.35147 11.3662 2.29173 11.4204 2.34323ZM13.8488 5.54408C13.5722 4.22978 12.9217 3.02219 11.9497 2.05017C10.6276 0.728068 8.86978 0 6.99997 0C5.13022 0 3.37234 0.728068 2.05024 2.05017C1.72867 2.37175 1.44266 2.71919 1.1933 3.0876C1.11914 3.18631 1.05272 3.29057 0.993673 3.39967C0.345935 4.476 0 5.71142 0 6.99997C0 8.86978 0.728131 10.6276 2.05024 11.9497C3.37234 13.2718 5.13022 14 6.99997 14C8.86978 14 10.6276 13.2718 11.9497 11.9497C12.5737 11.3258 13.0652 10.6047 13.4104 9.82064C13.4526 9.73376 13.4894 9.64481 13.5211 9.55409C13.8354 8.75105 14 7.88819 14 6.99997C14 6.51106 13.9498 6.03003 13.8526 5.56221C13.8513 5.55617 13.8501 5.55013 13.8488 5.54408Z"
									:fill="appStore.network === 'mainnet' ? '#4CDC89' : 'var(--orange)'" />
							</svg>
							<Text size="14" weight="600" color="primary" style="text-transform: capitalize">
								Frax {{ appStore.network }}
							</Text>
						</Flex>

						<Icon name="chevron" size="16" color="tertiary" />
					</Flex>

					<template #popup>
						<DropdownItem @click="appStore.network = 'mainnet'">
							<Flex align="center" gap="8">
								<Icon :name="appStore.network === 'mainnet' ? 'check' : ''" size="14"
									color="secondary" /> Mainnet
							</Flex>
						</DropdownItem>

					</template>
				</Dropdown>
			</Flex>

			<Feed :txs="txs" />

			<TPM />
		</Flex>

		<Flex direction="column" justify="between"> </Flex>
	</Flex>
</template>

<style module>
.wrapper {
	position: relative;
	width: 100%;
	height: 100%;

	overflow: hidden;
	background: var(--card-background);

	padding: 20px;
}

.atm_wrapper {
	position: absolute;
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;

	pointer-events: none;

	display: flex;
	align-items: center;
	justify-content: center;
}

.atm {
	aspect-ratio: auto 1/1;
	height: 90%;

	transform-origin: center;
	transform: rotate(-52deg);

	border-radius: 50%;

	box-shadow: #1f87dd52 -0.8em 0 5.8em -1.5em inset;

	animation: fhl 20s ease infinite;
	animation-delay: 10s;
}

.atm {
	box-shadow: #2374ffe0 -2em 0 3em -0.5em inset, #000e1ad9 -3em 0 4em -1em inset, #007aec30 -60em 0 20em -40em inset;
	mix-blend-mode: color-dodge;
	color: #4c86e99e;
	filter: blur(0.2em) drop-shadow(0.3em 0 4.5em);
	touch-action: none;
}

.atm::before,
.atm::after {
	content: "";
	display: block;
	height: 100%;
	border-radius: 50%;
	box-shadow: #2d8de7 -1.5em 0 1em -1em inset;
	mix-blend-mode: color-dodge;
}

.atm::after {
	margin-top: -100%;
}

@keyframes fhl {
	0% {
		opacity: 1;
		transform: rotate(-52deg) scale(1);
	}

	15% {
		opacity: 0;
	}

	30% {
		opacity: 0;
		transform: rotate(-52deg) scale(2);
	}

	32% {
		opacity: 0;
	}

	40% {
		opacity: 1;
		transform: rotate(-52deg) scale(1);
	}

	100% {
		opacity: 1;
		transform: rotate(-52deg) scale(1);
	}
}

.controls {
	z-index: 1;
}

.dot {
	width: 6px;
	height: 6px;

	border-radius: 50%;
	background: var(--op-10);
}

.network_selector {
	width: fit-content;
	height: 38px;

	border-radius: 10px;
	border: 2px solid var(--op-5);
	cursor: pointer;

	padding: 0 14px;

	transition: all 0.2s ease;

	&:hover {
		border: 2px solid var(--op-10);
	}

	&:active {
		border: 2px solid var(--op-15);
		background: var(--op-5);
	}
}
</style>
../local/TPM.vue
